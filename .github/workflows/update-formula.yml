name: Update formula

on:
  workflow_call:
    inputs:
      tag:
        required: true
        type: string
      source_repo:
        required: true
        type: string
      target_branch:
        required: false
        type: string
        default: main
      tap_repo:
        required: false
        type: string
        default: vllora/homebrew-vllora
      is_prerelease:
        required: false
        type: boolean
        default: true
    secrets:
      HOMEBREW_TAP_TOKEN:
        required: true

  workflow_dispatch:
    inputs:
      tag:
        description: Tag to update to (e.g. v0.4.0)
        required: true
        type: string
      source_repo:
        description: Owner/repo of the source releases
        required: true
        type: string
      target_branch:
        description: Target branch to push to or PR into
        required: false
        default: main
        type: string
      tap_repo:
        description: Owner/repo of the Homebrew tap to update
        required: false
        default: vllora/homebrew-vllora
        type: string
      is_prerelease:
        description: Whether the release is a prerelease
        required: false
        default: true
        type: boolean

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ inputs.tap_repo }}
          ref: ${{ inputs.target_branch }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Ensure authenticated remote points to tap repo
        run: |
          git remote set-url origin "https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/${{ inputs.tap_repo }}.git"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          mkdir -p release
          gh release download "${{ inputs.tag }}" \
            -R "${{ inputs.source_repo }}" \
            -D release --pattern "vllora-*"
          ls -lh release

      - name: Compute checksums
        id: shas
        run: |
          echo "linux_x64=$(sha256sum release/vllora-linux-x86_64 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "linux_arm=$(sha256sum release/vllora-linux-aarch64 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "mac_x64=$(sha256sum release/vllora-macos-x86_64 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "mac_arm=$(sha256sum release/vllora-macos-aarch64 | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Set output file name
        id: set_output_file
        env: 
          IS_PRERELEASE: ${{ inputs.is_prerelease }}
        run: |
          if [ "$IS_PRERELEASE" = true ]; then
            echo "output_file=Formula/vllora-beta.rb" >> $GITHUB_OUTPUT
            echo "class_name=VlloraBeta" >> $GITHUB_OUTPUT
          else
            echo "output_file=Formula/vllora.rb" >> $GITHUB_OUTPUT
            echo "class_name=Vllora" >> $GITHUB_OUTPUT
          fi

      - name: Update Formula/vllora.rb
        env:
          TAG: ${{ inputs.tag }}
          LINUX_X64_SHA: ${{ steps.shas.outputs.linux_x64 }}
          LINUX_ARM_SHA: ${{ steps.shas.outputs.linux_arm }}
          MAC_X64_SHA: ${{ steps.shas.outputs.mac_x64 }}
          MAC_ARM_SHA: ${{ steps.shas.outputs.mac_arm }}
          SOURCE_REPO: ${{ inputs.source_repo }}
          OUTPUT_FILE: ${{ steps.set_output_file.outputs.output_file }}
          CLASS_NAME: ${{ steps.set_output_file.outputs.class_name }}
        run: |
          VERSION="${TAG#v}"
          ORGREPO="$SOURCE_REPO"
          sed \
            -e "s/{{CLASS_NAME}}/${CLASS_NAME}/g" \
            -e "s/{{VERSION}}/${VERSION}/g" \
            -e "s/{{MAC_ARM_SHA}}/${MAC_ARM_SHA}/g" \
            -e "s/{{MAC_X64_SHA}}/${MAC_X64_SHA}/g" \
            -e "s/{{LINUX_ARM_SHA}}/${LINUX_ARM_SHA}/g" \
            -e "s/{{LINUX_X64_SHA}}/${LINUX_X64_SHA}/g" \
            -e "s|https://github.com/vllora/vllora/|https://github.com/${ORGREPO}/|g" \
            Formula/vllora_template.rb > "${OUTPUT_FILE}"

      - name: Commit and push
        env:
          TAG: ${{ inputs.tag }}
          OUTPUT_FILE: ${{ steps.set_output_file.outputs.output_file }}
        run: |
          git add "${OUTPUT_FILE}"
          if ! git diff --cached --quiet; then
            git commit -m "vllora ${TAG#v}: update checksums and URLs"
            git push origin HEAD:${{ inputs.target_branch }}
          else
            echo "No changes to commit"
          fi


